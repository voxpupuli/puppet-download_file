$webclient = New-Object System.Net.WebClient
$proxyAddress = '<%= @proxy_address %>'
$proxyUser = '<%= @proxy_user %>'
$proxyPassword = '<%= @proxy_password %>'
<% if @user_agent %>
$webclient.Headers['User-Agent'] = '<%= @user_agent %>'
<% end %>

<% if @allow_insecure_ssl %>
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Ssl3 -bor [Net.SecurityProtocolType]::Tls10 -bor [Net.SecurityProtocolType]::Tls11 -bor [Net.SecurityProtocolType]::Tls12
<% else %>
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls10 -bor [Net.SecurityProtocolType]::Tls11 -bor [Net.SecurityProtocolType]::Tls12
<% end %>

if ($proxyAddress -ne '') {
  if (!($proxyAddress.StartsWith('http://') -or $proxyAddress.StartsWith('https://'))) {
    $proxyAddress = 'http://' + $proxyAddress
  }

  $proxy = new-object System.Net.WebProxy
  $proxy.Address = $proxyAddress
  if (($proxyPassword -ne '') -and ($proxyUser -ne '')) {
  
    <% if @is_password_secure %>
    $password = ConvertTo-SecureString -string $proxyPassword
    <% else %>
    $password = ConvertTo-SecureString "$proxyPassword" -AsPlainText -Force
    <% end %>
    
    $proxy.Credentials = New-Object System.Management.Automation.PSCredential($proxyUser, $password)
    $webclient.UseDefaultCredentials = $true
  }
  $webclient.proxy = $proxy
}
<% if @cookies %>
<%= '$webclient.Headers.Add([System.Net.HttpRequestHeader]::Cookie, "' + @cookie_string + '")' %>
<% end %>
try {
  $webclient.DownloadFile('<%= @url %>', '<%= @destination_directory %>\<%= @filename %>')
}
catch [Exception] {
  write-host $_.Exception.GetType().FullName
  write-host $_.Exception.Message
  write-host $_.Exception.InnerException.Message
  throw $_.Exception
}
